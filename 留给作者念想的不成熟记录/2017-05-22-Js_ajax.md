layout: post
categories: JavaScript
title: "AJAX的那些事"
tags: [前端,JS]
---
![JS之AJAX](http://oltqt8zyb.bkt.clouddn.com/js_ajax-min.jpg)  

来自W3SCHOOL的解释：  

AJAX=异步JavaScript和XML，用于创建快速动态网页的技术。  

通过后台与服务器进行少量的数据交换，AJAX可以实现网页的异步刷新 。这意味着在不重新加载整个网页的情况下，对网页的某个部分进行更新。  

传统的网页（不使用AJAX）如需更新内容，必须加载整个页面。  
<!-- more -->
前言
--
既然配置好了本地服务器，那么可以熟悉一下AJAX和JSON，如果这个不熟悉，对我而言实在丢人啊！  

<p style="font-size:24px;">下面将使用原生JS和JQuery两种方式写出AJAX使用过程。</p>

不多说，开始干活！  

AJAX的基础
-------
AJAX扎根于XMLHttpRequest对象。XMLHttpRequest对象用于在后台和服务器进行数据交换，这就是异步的的基石了。  

### 创建XMLHttpRequest对象 ###

所有的现代浏览器（IE7+,firefox,chrome,Safari以及Opera）都内建了XMLHttpRequest对象。可惜还有很多的上古浏览器的存在，我们需要**兼容那个古老的浏览器IE6！**因此我们需要创建出兼容性好的XMLHttpRequest对象。  

```
//跨浏览器实例化XMLHttpRequest对象,兼容IE6+
function readyXHR () {
    try{
        return new XMLHttpRequest();
    }catch(e){
        //老版本的IE6使用ActiveX对象.
        try{
            return new ActiveXObject("Msxml2.XMLHTTP");
        }catch(e){
            //TODO handle the exception
            try{
                return new ActiveXObject("Microsoft.XMLHTTP");
            }catch(e){
                //TODO handle the exception
                return "无法实例化XMLHttpRequest对象";
            }
        }
    }
}
```

### XMLHttpRequest对象向服务器发送请求 ###
我们需要将请求发送到服务器，则需要使用到XMLHttpRequest对象的open()和send()方法。

| 方法 | 描述 |
| ------------- |-------------|
| open(method,url,async) | 规定请求的类型，URL,以及是否异步处理<br />1. method:请求的类型;POST或者GET类型<br />2. url:请求的文件位置<br /> 3. async: true代表异步处理；false代表同步处理 |
| send(string) | 将请求发送到服务器<br />string:此参数仅适用于POST请求 |

#### GET请求与POST请求的区别： ####
**与POST相比GET请求更简单也更快而且可以缓存数据，但是它的弊端就是不够安全而且有字符长度的限制。**  

**传输密码一类的重要信息的时候,要使用POST请求类型!**

#### GET请求 ####
```
var xhr=readyXHR();
var sendUrl="http://www.braingia.org/addtwo.php?num1=2&num2=56";
xhr.open("GET",sendUrl,true);
xhr.send();  //一定要有
```
#### POST请求 ####
```
var xhr=readyXHR();
var sendUrl="../php/isbn.php";
xhr.open("POST",sendUrl,true);
xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"); //使用POST方式传递数据，使用setRequestHeader()添加HTTP头，然后再send()方法中规定传递的参数。
var form=“fname=aaa”+“&lname=bbb”;  //规定send的参数为fname和lname，注意两个字符串用&连接
xhr.send(form);
```

### onreadystatechange 事件 ###
发送请求之后发生了什么呢？服务器会对发送的数据进行后台处理，此时会返回一些响应信息，我们就需要对响应信息做一些处理，即当readyState（该属性存有XMLHttpRequest的状态信息）改变时，对onreadystatechange事件做处理！  

W3school文档中介绍了XMLHttpRequest对象的三个重要的属性：  

| 属性 | 描述 |
| ------------- |-------------|
| onreadystatechange | 存储函数（或函数名），每当readyState属性改变时，都会调用此函数，**如果响应正常的话，一般会调用5次，从0-4** |
| readyState | 存有XMLHttpRequest的状态。从0-4变化<br /> - 0: 请求未初始化<br /> - 1: 服务器联建已建立<br /> - 2: 请求已接受<br /> - 3: 请求处理中<br /> - 4: 请求已完成且响应已就绪 |
| status | 200:"OK"<br />404:未找到页面 |

**当readyState=4且status=200时，表示响应已就绪！**
```
xhr.onreadystatechange=function () {
        if(xhr.readyState==4){
            if(xhr.status==200){
                alert(xhr.responseText); //服务器响应
            }
            else{
                alert(xhr.statusText);
            }
        }
    }
```

### 服务器响应 ###
到了这一步，需要了解一下服务器返回给我们什么东西了呢？  

想要获得服务器响应，可以使用XMLHttpRequest对象的responseText或者responseXML这两个属性。  

| 属性 | 描述 |
| ------------- |-------------|
| responseText | 获得字符串形式的响应数据 |
| responseXML | 获得XML形式的响应数据 |

### 使用callback函数 ###
**什么是callback函数呢？这是一种以参数形式传递给另一个函数的函数！**  

W3school提到的问题很好！如果你的网站上存在多个AJAX任务，那么应该**为创建XMLHttpRequest对象编写一个标准的函数**。并且为每个AJAX任务调用该函数！  

按照W3school的建议，写如下基本的AJAX集：  

HTML:
```
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>AJAX</title>
	</head>
	<body>
	    <div class="data">
	        <button id="ajax01">测试一</button>
	        <button id="ajax02">测试二</button>
	    </div>
	    <script type="text/javascript" src="../Js/Ajax_XMLHttpRequest.js" ></script>
	</body>
</html>
```

JS:
```
//跨浏览器实例化XMLHttpRequest对象,兼容IE6+
var xhrdemo={
    xhrAjax : function () {
        try{
            return new XMLHttpRequest();
        }
        catch(e){
            //TODO handle the exception
            try{
                return new ActiveXObject("Msxml2.XMLHTTP");
            }
            catch(e){
                //TODO handle the exception
                try{
                    return new ActiveXObject("Microsoft.XMLHTTP");
                }
                catch(e){
                    //TODO handle the exception
                    return "无法实例化XMLHttpRequest对象";
                }
            }
        }
    },
    
    xhrSendGet:function (xhr,url) {
        xhr.open("GET",url,true);
        xhr.send();
    },
    
    xhrSendPost:function (xhr,url,params) {
        xhr.open("POST",url,true);
        xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
        if(params!=null)
            xhr.send(params);
        else
            xhr.send();
    },
    
    xhrReadyState: function (xhr,xhrSRC) {
        xhr.onreadystatechange=function () {
            if(xhr.readyState==4 && xhr.status==200){
                xhrSRC();
            }
        };
    }
};

//第一个例子,节点加载完才可以添加点击事件
var ajax01=document.getElementById("ajax01");
ajax01.onclick=function () {
    var xhr=xhrdemo.xhrAjax();
    var getUrl="http://www.braingia.org/addtwo.php?num1=2&num2=56";
    xhrdemo.xhrSendGet(xhr,getUrl);
    function xhrsucc () {
        alert("尝试成功过！");
    }
    xhrdemo.xhrReadyState(xhr,xhrsucc);
}
//第二个例子isbn.php?
var ajax02=document.getElementById("ajax02");
ajax02.onclick = function () {
    var xhr=xhrdemo.xhrAjax();
    var sendUrl="../php/isbn.php";
    var form="isbn=9";
    xhrdemo.xhrSendPost(xhr,sendUrl,form);
    function xhrsucc () {
        alert("尝试成功过111！");
    }
    xhrdemo.xhrReadyState(xhr,xhrsucc);
}
```
<hr />

用JQuery编写AJAX
-------------
### JQuery的GET方法请求数据 ###
语法：
```
$.get(URL,callback);
```
URL:规定希望请求的URL。  
callback:请求成功后所执行的函数名。 回调函数有两个参数：(data,status)，分别代表返回数据和请求状态。

**实例：**
```
<!DOCTYPE html>
<html>
	<head>
		<script src="/jquery/jquery-1.11.1.min.js"></script>
		<script>
			$(document).ready(function(){
				$("button").click(function(){
					$.get("/example/jquery/demo_test.asp",function(data,status){
						alert(data+","+status);
					});
				});
			});
		</script>
	</head>
	<body>	
		<button>向页面发送 HTTP GET 请求，然后获得返回的结果</button>
	</body>
</html>
```

### JQuery的POST方法发送数据 ###
语法：
```
$.post(URL,data,callback);
```
URL:规定希望请求的URL。  
data:规定同请求一起发送的数据。  
callback:请求成功后所执行的函数名。 回调函数有两个参数：(data,status)，分别代表返回数据和请求状态。

**实例：**
```
<!DOCTYPE html>
<html>
	<head>
		<script src="/jquery/jquery-1.11.1.min.js"></script>
		<script>
			$(document).ready(function(){
				$("button").click(function(){
					$.post(
					"/example/jquery/demo_test.asp",
					{
						name:"aaa",
						city:"淮安"
					},
					function(data,status){
						alert(data+","+status);
					});
				});
			});
		</script>
	</head>
	<body>	
		<button>向页面发送 HTTP GET 请求，然后获得返回的结果</button>
	</body>
</html>
```